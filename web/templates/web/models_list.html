{% extends "web/base.html" %}

{% block title %}CORDEX Experiment Manager | Models {% endblock %}

{% block content %}

<h3>You have described <strong>{{ user_models|length }}</strong> models</h3>

{% if user_models.count > 0 %}

<h4>You can now create new submissions related to these models for experiments listed under the <a href="{% url 'web-experiments' 'cordex-esd'%}">Experiments</a> section of the platform</h4>

<table class="table table-striped table-condensed">
	<tr>
		<td><strong>Name</strong></td>
	    <td><strong>Description</strong></td>
      <td><strong>Meta-data</strong></td>
	    <td><strong>Actions</strong></td>
	</tr>
  {% for model in user_models.all %}
    <tr>
      <td>{{ model.title }}</td>
      <td>{{ model.description }}</td>

      <td><a href={% url 'web-model-edit' model.slug %}>edit meta data</a></td>
      
      <td><span data-toggle="modal" data-target="#delete-modal-{{ model.id }}" title="Delete this model" class="glyphicon glyphicon-remove-circle"></span>

        <div class="modal fade" id="delete-modal-{{ model.id }}" aria-labelledby="delete-modal-{{ model.id}}-label">
          <div class="modal-dialog">
            <div class="modal-content">
              <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                <h4 class="modal-title" id="delete-model-{{ modal.id}}-label">Confirm Delete Model?</h4>
              </div>
              <div class="modal-body">
                  Deleting a model will also delete all submissions associated with the model.  Please confirm that you wish to delete this model ({{ model.title }}) and associated submissions.
              </div>
              <div class="modal-footer">
                <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                <a href="{% url 'api:model-detail' model.id %}" type="button" class="model-delete btn btn-primary" id="delete-modal-confirm-{{ model.id }}">Confirm Delete</a>
              </div>
            </div><!-- /.modal-content -->
          </div><!-- /.modal-dialog -->
        </div><!-- /.modal -->

    </td>
    </tr>
  {% endfor %}
</table>
{% endif %}

<h3>Add a new model description:</h3>
  <form action="{% url 'api:model-list' %}" method="POST" class="model-form">
    {% csrf_token %}
    
    <input type="hidden" name="slug" id="model-slug">
    <label for="model-name">Model name/title  </label>(<span id="slug-value"></span>)
    <input type="text" name="title" class="form-control" id="model-name" placeholder="Enter a name for the model">

    <label for="model-description">Brief description</label>
    <textarea name="description" class="form-control" id="model-description" placeholder="Enter a brief description of the model"></textarea>

    <input type="hidden" name="contact" value="{{ user_profile.id }}">
    <input type="submit" value="Create model description">
  </form>
  <hr>
  <h3>Model Meta-data</h3>

  {% for term in meta_terms %}

  <form action="{% url 'api:modelmeta-list' %}" method="POST" class="modelmeta-form">
    {% csrf_token %}
    <input type="hidden" name="term" value="{{ term.id }}">

    <div class="row">
      {% if term.multiple %}
          <div class="col-md-4">
            <p><strong>{{ term.long_name }}</strong></p>
            {% for value in term.values.all %}
              <input type="checkbox" name="value" value="{{ value }}">{{ value }}</input><br/>
            {% endfor %}
          </div>
          <div class="col-md-8">
            <p>{{ term.help_text }}</p>
          </div>
      {% endif %}

      {% if not term.multiple %}
          <div class="col-md-4">
            <p><strong>{{ term.long_name }}</strong></p>
            {% for value in term.values.all %}
              <input type="radio" name="value" value="{{ value }}">{{ value }}</input><br/>
            {% endfor %}
          </div>
          <div class="col-md-8">
            <p>{{ term.help_text }}</p>
          </div>
      {% endif %}
    </div>
    <hr/>
  </form>
  {% endfor %}




<script>

function submit_metaterms(model_id) {

  $(".modelmeta-form").each(function(idx, form) {
    console.log("attempting to submit form");

    var url = $(form).attr('action');
    var formdata = new FormData(form);
    formdata.append('model', model_id);

    console.log(formdata);
    console.log(url);

    $.ajax({
        url: url,
        type: 'POST',
        data: formdata,
        contentType: false,
        processData: false,
        success: function(res) {
          console.log('success!');
          console.log(res.id);
        },

    });


  });  
}

  $(document).ready(function() {

  	  $("#model-name").change(function() {

  	  		var title = $("#model-name").val();
  	  		var slug = getSlug(title);
  	  		$("#slug-value").html(slug);
  	  		$("#model-slug").val(slug);

  	  });

      $(".model-form").submit(function(e) {
          
          var formdata = new FormData(e.target);
          console.log('submitting');
          var url = $(e.target).attr('action');
          console.log('url = ' + url);
          
          $.ajax({
              url: url,
              type: 'POST',
              data: formdata,
              contentType: false,
              processData: false,
              success: function(res) {
                console.log('success!');
                console.log(res.id);
                submit_metaterms(res.id);
                location.reload();
              },

          });

          return false;
      });

      $(".model-delete").click(function(e) {
          var formdata = new FormData();
          console.log("delete!");
          var url = $(e.target).attr('href');
          console.log(url);
          
          formdata.append('csrfmiddlewaretoken', '{{ csrf_token }}');
          formdata.append('_method', 'DELETE');

          $.ajax({
              url: url,
              data: formdata,
              contentType: false,
              processData: false,
              type: 'POST',
              success: function(res) { 
                console.log('response: ' + res);
                location.reload();
              }
          });

          return false;    
      });

  });
</script>

{% endblock %}