{% extends "web/base.html" %}

{% block title %}CORDEX Experiment Manager | Experiments {% endblock %}

{% block content %}

    <div class="row">
      <h3><a href="{% url 'web-experiments' project.slug %}">{{ project.title }}</a></h3>
      <h4>{{ meta_experiment.title }} > {{ experiment.title }}</h4><hr/>
    </div>

    <div class="row">
      <h4>You currently have <strong>{{ user_submissions|length }}</strong> submissions active for this experiment ({{ meta_experiment }} > {{ experiment }})</h4>
      <a class="btn btn-warning" href="#add_submission">Add a new submission</a>
      <hr/>
    </div>

    <div class="row">
      {% for submission in user_submissions %}
        <div class="panel panel-default">
          <div class="panel-heading">{{ submission }} #{{ submission.id }}</div>
          <div class="panel-body">
              <p>Created: {{ submission.created | date:'H:m D M Y' }} ( last modified: {{ submission.modified | date:'H:m D M Y' }} )</p>
              {% if submission.notes %}
                <p>Notes: {{ submission.notes }} </p>
              {% endif %}            
              <hr/>
              
              <p>
                {% if submission.uploads.all.count == 0 %}
                You have not uploaded any files to this submission
                {% else %}
                You have uploaded <strong>{{ submission.uploads.all | length }}</strong> files to this submission
                {% endif %}
              </p>
              <table class="table table-striped table-condensed">
                <tr>
                  <td><strong>File</strong></td>
                  <td><strong>Format</strong></td>
                  <td><strong>Timestamp</strong></td>
                  <td><strong>Status</strong></td>
                  <td><strong>Actions</strong></td>
                </tr>
              {% for upload in submission.uploads.all %}
                <tr>
                  <td>{{ upload.uploaded.url }}</td>
                  <td>{{ upload.format }}</td>
                  <td>{{ upload.timestamp | date:'H:m D M Y' }}</td>
                  <td>{{ upload.status }}</td>
                  <td><a class="upload-delete" href="{% url 'api:upload-detail' upload.id %}"><span data-toggle="tooltip" data-placement="bottom" title="Delete this upload" class="glyphicon glyphicon-remove-circle"></span></a></td>
                </tr>
              {% endfor %}
              </table>

              <form class="upload-form" action="{% url 'api:upload-list' %}" method="POST" enctype="multipart/form-data">
                  {% csrf_token %}
                  <input type="hidden" name="submission" value="{{ submission.id }}">

                  <div class="form-group">
                      <label for="{{ upload_form.uploaded.id_for_label }}">Select a file to upload</label>
                        {{ upload_form.uploaded }}
                  </div>
                  <div class="form-group">
                      <label for="{{ upload_form.format.id_for_label }}">Select the data format of the uploaded file</label>
                       {{ upload_form.format }}
                  </div>
                  <input type="submit" value="upload">
              </form>
          </div>
        </div>
      {% endfor %}
    </div>


    <div class="row">
          <a id="add_submission"></a>
          <div class="panel panel-warning">
            <div class="panel-heading">Create a new submission</div>
            <div class="panel-body">
              <form method="post" action="{% url 'web-experiment-submissions' project.slug meta_experiment.slug experiment.slug %}">
              {% csrf_token %}
                <p>Your submission will be under the {{ project }} project and for experiment {{ meta_experiment }} > {{ experiment }}</p>

                <input type="hidden" name="project" value="{{ project.id }}">
                <input type="hidden" name="experiment" value="{{ experiment.id }}">
                <input type="hidden" name="owner" value="{{ user_profile.id }}">


                <div class="form-group">
                  <label for="{{ form.model.id_for_label }}">Select which of your saved models was used for this submission</label>
                  {{ form.model }}{{ form.model.errors }} <a href="{% url 'web-profile' %}">Add models to your profile</a>

                </div>

                <div class="form-group">
                  <label for="id_notes">Notes</label>
                  <textarea id="id_notes" name="notes" class="form-control" placeholder="Enter any relevant notes to yourself or others"></textarea>
                </div>
                <input type="submit" class="form-control btn btn-primary" value="Create new submission">
              </form>

            </div>
          </div>
    </div>




    <script>

      $(document).ready(function() {

          $(function () {
              $('[data-toggle="tooltip"]').tooltip()
          });

          $(".upload-form").submit(function(e) {
              
              var formdata = new FormData(e.target);
              console.log('submitting');
              var url = $(e.target).attr('action');
              console.log('url = ' + url);
              
              $.ajax({
                  url: url,
                  type: 'POST',
                  data: formdata,
                  contentType: false,
                  processData: false,
                  success: function(res) { 
                    console.log('success!');
                    location.reload();
                  },

              });

              return false;
          });

          $(".upload-delete > span").click(function(e) {
              alert('deleting');
              var formdata = new FormData();
              console.log("delete!");
              var url = $(e.target).parent().attr('href');
              console.log(url);
              
              formdata.append('csrfmiddlewaretoken', '{{ csrf_token }}');
              formdata.append('_method', 'DELETE');

              $.ajax({
                  url: url,
                  data: formdata,
                  contentType: false,
                  processData: false,
                  type: 'POST',
                  success: function(res) { 
                    console.log('response: ' + res);
                    location.reload();
                  }
              });

              return false;    
          });

      });
    </script>

{% endblock %}

