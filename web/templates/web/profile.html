{% extends "web/base.html" %}

{% block title %}CORDEX Experiment Manager | Profile {% endblock %}

{% block content %}

	<div class="row">
		<h3>Name: {{ user.first_name }} {{ user.last_name}}</h3>
    <h4>Email: {{ user.email }}</h4>
	</div>

	{% if not show_form %}
		<div class="row">
			<h4>Affiliation: {{ user_profile.institution }}</h4>
			<h4>Country: {{ user_profile.country }}</h4>
			<a class="btn btn-primary btn-sm" href="{% url 'web-profile' %}?edit" role="button">Edit user details</a>
		</div>
	{% else %}
		<div class="row">
			<form action="{% url 'web-profile' %}" method="POST">
				{% csrf_token %}
				 <div class="form-group">
    				<label for="instution">Institution</label>
    				<input type="text" name="institution" class="form-control" id="institution" placeholder="Enter your instution name" value="{{ user_profile.institution }}">
    				<label for="country">Country</label>
    				<input type="text" name="country" class="form-control" id="country" placeholder="Country name" value="{{ user_profile.country }}">
 				 </div>
				<input type="submit" value="update details">
			</form>

		</div>
	{% endif %}
	<hr/>
	{% if not show_form %}
	<div class="row">
		<h3>You have described <strong>{{ user_models|length }}</strong> models</h3>

		{% if user_models.count > 0 %}
		<table class="table table-striped table-condensed">
	        <tr>
	          <td><strong>Name</strong></td>
	          <td><strong>Description</strong></td>
	          <td><strong>Actions</strong></td>
	        </tr>
	      {% for model in user_models.all %}
	        <tr>
	          <td>{{ model.title }}</td>
	          <td>{{ model.description }}</td>
	          <td><a class="model-delete" href="/api/models/{{ model.id }}/"><span data-toggle="tooltip" data-placement="bottom" title="Delete this model" class="glyphicon glyphicon-remove-circle"></span></a></td>
	        </tr>
	      {% endfor %}
        </table>
        {% endif %}

		<h3>Add a model description:</h3>
		<form action="{% url 'api:model-list' %}" method="POST" class="model-form">
			{% csrf_token %}
			
			<input type="hidden" name="slug" id="model-slug">
			<label for="model-name">Model name/title  </label>(<span id="slug-value"></span>)
			<input type="text" name="title" class="form-control" id="model-name" placeholder="Enter a name for the model">

			<label for="model-description">Brief description</label>
			<textarea name="description" class="form-control" id="model-description" placeholder="Enter a brief description of the model"></textarea>

			<input type="hidden" name="contact" value="{{ user_profile.id }}">

			<input type="submit" value="Create model description">
		</form>
	</div>
	{% endif %}

    <script>

      $(document).ready(function() {

      	  $("#model-name").change(function() {

      	  		var title = $("#model-name").val();
      	  		var slug = getSlug(title);
      	  		$("#slug-value").html(slug);
      	  		$("#model-slug").val(slug);

      	  });
      

          $(".model-form").submit(function(e) {
              
              var formdata = new FormData(e.target);
              console.log('submitting');
              var url = $(e.target).attr('action');
              console.log('url = ' + url);
              
              $.ajax({
                  url: url,
                  type: 'POST',
                  data: formdata,
                  contentType: false,
                  processData: false,
                  success: function(res) { 
                    console.log('success!');
                    location.reload();
                  },

              });

              return false;
          });

          $(".model-delete > span").click(function(e) {
              var formdata = new FormData();
              console.log("delete!");
              var url = $(e.target).parent().attr('href');
              console.log(url);
              
              formdata.append('csrfmiddlewaretoken', '{{ csrf_token }}');
              formdata.append('_method', 'DELETE');

              $.ajax({
                  url: url,
                  data: formdata,
                  contentType: false,
                  processData: false,
                  type: 'POST',
                  success: function(res) { 
                    console.log('response: ' + res);
                    location.reload();
                  }
              });

              return false;    
          });

      });
    </script>

{% endblock %}