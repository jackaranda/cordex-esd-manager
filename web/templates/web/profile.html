{% extends "web/base.html" %}

{% block title %}CORDEX Experiment Manager | Profile {% endblock %}

{% block content %}

	<div class="row">
		<h3>Name: {{ user.first_name }} {{ user.last_name}}</h3>
    <h4>Email: {{ user.email }}</h4>
	</div>

	{% if not show_form %}
		<div class="row">
			<h4>Affiliation: {{ user_profile.institution }}</h4>
			<h4>Country: {{ user_profile.country }}</h4>
			<a class="btn btn-primary btn-sm" href="{% url 'web-profile' %}?edit" role="button">Edit user details</a>
		</div>
	{% else %}
		<div class="row">
			<form action="{% url 'web-profile' %}" method="POST">
				{% csrf_token %}
				 <div class="form-group">
    				<label for="instution">Institution</label>
    				<input type="text" name="institution" class="form-control" id="institution" placeholder="Enter your instution name" value="{{ user_profile.institution }}">
    				<label for="country">Country</label>
    				<input type="text" name="country" class="form-control" id="country" placeholder="Country name" value="{{ user_profile.country }}">
 				 </div>
				<input type="submit" value="update details">
			</form>

		</div>
	{% endif %}
	<hr/>
	{% if not show_form %}
	<div class="row">
		<h3>You have described <strong>{{ user_models|length }}</strong> models</h3>

		{% if user_models.count > 0 %}

    <h4>You can now create new submissions related to these models for experiments listed under the <a href="{% url 'web-experiments' 'cordex-esd'%}">Experiments</a> section of the platform</h4>

		<table class="table table-striped table-condensed">
	        <tr>
	          <td><strong>Name</strong></td>
	          <td><strong>Description</strong></td>
	          <td><strong>Actions</strong></td>
	        </tr>
	      {% for model in user_models.all %}
	        <tr>
	          <td>{{ model.title }}</td>
	          <td>{{ model.description }}</td>
	          <td><span data-toggle="modal" data-target="#delete-modal-{{ model.id }}" title="Delete this model" class="glyphicon glyphicon-remove-circle"></span></a>

                <div class="modal fade" id="delete-modal-{{ model.id }}" aria-labelledby="delete-modal-{{ model.id}}-label">
                  <div class="modal-dialog">
                    <div class="modal-content">
                      <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="delete-model-{{ modal.id}}-label">Confirm Delete Model?</h4>
                      </div>
                      <div class="modal-body">
                          Deleting a model will also delete all submissions associated with the model.  Please confirm that you wish to delete this model ({{ model.title }}) and associated submissions.
                      </div>
                      <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">Cancel</button>
                        <a href="{% url 'api:model-detail' model.id %}" type="button" class="model-delete btn btn-primary" id="delete-modal-confirm-{{ model.id }}">Confirm Delete</a>
                      </div>
                    </div><!-- /.modal-content -->
                  </div><!-- /.modal-dialog -->
                </div><!-- /.modal -->

            </td>
	        </tr>
	      {% endfor %}
        </table>
        {% endif %}

    <hr/>
		<h3>Add a new model description:</h3>
		<form action="{% url 'api:model-list' %}" method="POST" class="model-form">
			{% csrf_token %}
			
			<input type="hidden" name="slug" id="model-slug">
			<label for="model-name">Model name/title  </label>(<span id="slug-value"></span>)
			<input type="text" name="title" class="form-control" id="model-name" placeholder="Enter a name for the model">

			<label for="model-description">Brief description</label>
			<textarea name="description" class="form-control" id="model-description" placeholder="Enter a brief description of the model"></textarea>

			<input type="hidden" name="contact" value="{{ user_profile.id }}">
      <hr>
      <h3>Model Meta-data</h3>

      {% for term in meta_terms %}

      <div class="row">
        {% if term.multiple %}
            <div class="col-md-4">
              <p><strong>{{ term.long_name }}</strong></p>
              {% for value in term.values.all %}
                <input type="checkbox" name="metadata" value="{{ term }}:{{ value }}">{{ value }}</input><br/>
              {% endfor %}
              {% if term.freetext %}
                <input type="checkbox" name="metadata" value="{{ term }}:other">other</input><br/>
                other details: <input type="text" name="metadata"></input>
              {% endif %}
            </div>
            <div class="col-md-8">
              <p>{{ term.help_text }}</p>
            </div>
        {% endif %}

        {% if not term.multiple %}
            <div class="col-md-4">
              <p><strong>{{ term.long_name }}</strong></p>
              {% for value in term.values.all %}
                <input type="radio" name="metadata" value="{{ term }}:{{ value }}">{{ value }}</input><br/>
              {% endfor %}
              {% if term.freetext %}
                <input type="checkbox" name="metadata" value="{{ term }}:other:">other</input><br/>
                other details: <input type="text" name="metadata"></input>
              {% endif %}
            </div>
            <div class="col-md-8">
              <p>{{ term.help_text }}</p>
            </div>
        {% endif %}
      </div>
      <hr/>
      {% endfor %}


			<input type="submit" value="Create model description">
		</form>
	</div>
	{% endif %}

    <script>

      $(document).ready(function() {

      	  $("#model-name").change(function() {

      	  		var title = $("#model-name").val();
      	  		var slug = getSlug(title);
      	  		$("#slug-value").html(slug);
      	  		$("#model-slug").val(slug);

      	  });
      

          $(".model-form").submit(function(e) {
              
              var formdata = new FormData(e.target);
              console.log('submitting');
              var url = $(e.target).attr('action');
              console.log('url = ' + url);
              
              $.ajax({
                  url: url,
                  type: 'POST',
                  data: formdata,
                  contentType: false,
                  processData: false,
                  success: function(res) { 
                    console.log('success!');
                    location.reload();
                  },

              });

              return false;
          });

          $(".model-delete").click(function(e) {
              var formdata = new FormData();
              console.log("delete!");
              var url = $(e.target).attr('href');
              console.log(url);
              
              formdata.append('csrfmiddlewaretoken', '{{ csrf_token }}');
              formdata.append('_method', 'DELETE');

              $.ajax({
                  url: url,
                  data: formdata,
                  contentType: false,
                  processData: false,
                  type: 'POST',
                  success: function(res) { 
                    console.log('response: ' + res);
                    location.reload();
                  }
              });

              return false;    
          });

      });
    </script>

{% endblock %}